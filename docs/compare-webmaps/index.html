<!DOCTYPE html>
<html lang="en">

<head>
  <script>
    let frame1, frame2;
    let loaded = false;
    let debug = false; // for more console messages
    window.addEventListener("load", () => {
      (async () => {
        // step 1. set up variables
        const href = window.location.href;
        const url = new URL(href);
        const sync = url.searchParams.get("sync") || "true";
        const webmapId = url.searchParams.get("webmaps") || url.searchParams.get("webmap") || '2ee3425c0eb045ffa0d87bfd1e16a0aa';
        let webmapId1, webmapId2;
        const portals = url.searchParams.get("portals") || url.searchParams.get("portal") || 'https://www.arcgis.com';
        let portal1, portal2;
        const themes = url.searchParams.get("themes") || url.searchParams.get("theme") || "dark";
        let theme1, theme2;
        // specify version using ?versions=4.19 OR full URL using ?api=https://js.arcgis.com/next/
        let api1, api2;
        // specify locale using ?locales
        const locales = url.searchParams.get("locales") || url.searchParams.get("locale") || 'en';
        let locale1, locale2;
        const useapikeys = url.searchParams.get("useapikey") || 'false';
        let useapikey1, useapikey2;
        const editbookmarks = url.searchParams.get("editbookmarks") || url.searchParams.get("editbookmark") || false;
        let editbookmarks1, editbookmarks2;
        let show = url.searchParams.get("show") || 'layerlist,search';
        // step 2. figure out things out
        await setParams();
        // step 3 - load the frames
        loadFrames();

        async function setParams() {
          if (webmapId.includes(',')) {
            [webmapId1, webmapId2] = webmapId.split(',');
          } else {
            webmapId1 = webmapId2 = webmapId;
          }
          if (portals.includes(',')) {
            [portal1, portal2] = portals.split(',');
          } else {
            portal1 = portal2 = portals;
          }
          if (portal1 == 'devext') {
            portal1 = 'https://devext.arcgis.com';
          } else if (portal1 == 'qaext') {
            portal1 = 'https://qaext.arcgis.com';
          }
          if (portal2 == 'devext') {
            portal2 = 'https://devext.arcgis.com';
          } else if (portal2 == 'qaext') {
            portal2 = 'https://qaext.arcgis.com';
          }
          if (themes.includes(',')) {
            [theme1, theme2] = themes.split(',');
          } else {
            theme1 = theme2 = themes;
          }
          // "api/apis" takes preference over "version/versions"
          if (url.searchParams.has("api") || url.searchParams.has("apis")) {
            const apis = url.searchParams.get("api") || url.searchParams.get("apis");
            if (apis.includes(',')) {
              [api1, api2] = apis.split(',');
            } else {
              api1 = api2 = apis;
            }
          } else {
            const versions = url.searchParams.get("versions") || url.searchParams.get("version");
            if (versions && versions.includes(',')) {
              const [version1, version2] = versions.split(',');
              api1 = (version1 == 'next' ? 'https://jsdev.arcgis.com/' : 'https://js.arcgis.com/') + version1 + '/';
              api2 = (version2 == 'next' ? 'https://jsdev.arcgis.com/' : 'https://js.arcgis.com/') + version2 + '/';
            } else if (versions) {
              api1 = api2 = (versions == 'next' ? 'https://jsdev.arcgis.com/' : 'https://js.arcgis.com/') + versions + '/';
            } else {
              // default to latest and next versions
              const latestversion = await npminfo("https://registry.npmjs.org/@arcgis/core");
              api1 = 'https://js.arcgis.com/' + latestversion + '/';
              api2 = 'https://jsdev.arcgis.com/next/';
            }
          }
          if (locales.includes(',')) {
            [locale1, locale2] = locales.split(',');
          } else {
            locale1 = locale2 = locales;
          }
          if (useapikeys && useapikeys.includes(',')) {
            [useapikey1, useapikey2] = useapikey.split(',');
          } else {
            useapikey1 = useapikey2 = useapikeys;
          }
          if (editbookmarks && editbookmarks.includes(',')) {
            [editbookmarks1, editbookmarks2] = editbookmarks.split(',');
          } else {
            editbookmarks1 = editbookmarks2 = editbookmarks;
          }
        } // setParams

        function loadFrames() {
          frame1 = document.getElementById('frame1');
          frame2 = document.getElementById('frame2');
          window.open('webmap.html?api=' + api1 + '&webmap=' + webmapId1 +
            '&portal=' + portal1 + '&locale=' + locale1 + '&theme=' + theme1 +
            '&show=' + show + '&editbookmarks=' + editbookmarks1 + '&useapikey=' + useapikey1, 'frame1');
          window.open('webmap.html?api=' + api2 + '&webmap=' + webmapId2 +
            '&portal=' + portal2 + '&locale=' + locale2 + '&theme=' + theme2 +
            '&show=' + show + '&editbookmarks=' + editbookmarks2 + '&useapikey=' + useapikey2, 'frame2');
        } // end the big async

        async function npminfo(url, comment) {
          let latestversion;
          await fetch(url, {
              method: "GET"
            })
            .then(function(response) {
              return response.text();
            })
            .then(async function(jsonresponse) {
              let obj = JSON.parse(jsonresponse);
              const tags = obj["dist-tags"];
              const majorminorregex = /^(\d+)\.(\d+)/;
              latestversion = tags["latest"].match(majorminorregex)[0];
            })
            .catch(function(error) {
              console.log(
                `fetch oops for ${url}\n${error}\n${error.message}`,
                error,
                "\n",
                error.message
              );
            }); // end await fetch
            return latestversion;
          }; // end npminfo

      })();
    });
  </script>
</head>

<frameset cols="50%,50%">
  <frame src="" name="frame1" id="frame1">
    <frame src="" name="frame2" id="frame2">
</frameset>

</html>